{% extends "base.html" %}
{% block title %}{{ _('Maintenance') }} | Fresado Pro{% endblock %}
{% block instructions %}
<div class="alert alert-info d-flex align-items-center" role="alert">
  <i class="bi bi-gear me-2"></i>
  {{ _('Register and view maintenance activities. Use groups to filter and keep your lab in optimal condition.') }}
</div>
{% endblock %}
{% block content %}
<div class="container-fluid px-0 mb-3">
  <div class="d-flex justify-content-end">
    <a class="btn btn-outline-info" href="{{ url_for('mantenimiento.documentacion') }}" target="_blank">
      <i class="bi bi-journal-text"></i> {{ _('Documentation') }}
    </a>
  </div>
</div>
<div class="card border-0 shadow-sm animate__animated animate__fadeInUp">
  <div class="card-body">
    <h3 class="mb-3"><i class="bi bi-gear"></i> {{ _('Maintenance and Calibrations') }}</h3>
    <div class="mb-3">
      <a href="{{ url_for('mantenimiento.mantenimiento', grupo='fresadoras') }}" class="btn btn-outline-primary {% if grupo == 'fresadoras' %}active{% endif %}"><i class="bi bi-cpu"></i> {{ _('Milling Machines') }}</a>
      <a href="{{ url_for('mantenimiento.mantenimiento', grupo='hornos') }}" class="btn btn-outline-warning {% if grupo == 'hornos' %}active{% endif %}"><i class="bi bi-fire"></i> {{ _('Ovens') }}</a>
      <a href="{{ url_for('mantenimiento.mantenimiento', grupo='aspiradoras') }}" class="btn btn-outline-success {% if grupo == 'aspiradoras' %}active{% endif %}"><i class="bi bi-wind"></i> {{ _('Vacuum Cleaners') }}</a>
    </div>
    <form method="post" class="row g-3 mb-4">
      <div class="col-md-4">
        <label class="form-label">{{ _('Machine') }}</label>
        <select name="maquina" class="form-select" size="4" required>
          {% for m in maquinas %}
            <option value="{{ m }}">{{ m }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ _('Activity') }}</label>
        <select name="actividad" class="form-select" required>
          {% for act in actividades %}
            <option value="{{ act.nombre }}">{{ act.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">{{ _('Every') }}</label>
        <input type="number" name="intervalo" class="form-control" min="1" value="1" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">{{ _('Unit') }}</label>
        <select name="unidad" class="form-select" required>
          <option value="semana">{{ _('Week(s)') }}</option>
          <option value="mes">{{ _('Month(s)') }}</option>
          <option value="aÃ±o">{{ _('Year(s)') }}</option>
        </select>
      </div>
      <div class="col-md-12">
        <label class="form-label">{{ _('Description') }}</label>
        <input type="text" name="descripcion" class="form-control">
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary"><i class="bi bi-plus-circle"></i> {{ _('Register Maintenance') }}</button>
      </div>
    </form>
    <div class="row g-4">
      <div class="col-md-8">
        <div class="table-responsive animate__animated animate__fadeIn">
          <table class="table table-striped table-hover" id="tabla-mant">
            <thead class="table-info">
              <tr>
                <th><i class="bi bi-calendar"></i> {{ _('Date') }}</th>
                <th><i class="bi bi-cpu"></i> {{ _('Machine') }}</th>
                <th><i class="bi bi-gear"></i> {{ _('Activity') }}</th>
                <th><i class="bi bi-card-text"></i> {{ _('Description') }}</th>
                <th><i class="bi bi-calendar-check"></i> {{ _('Next') }}</th>
                <th><i class="bi bi-gear"></i> {{ _('Actions') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for reg in registros %}
              <tr>
                <td>{{ reg.fecha.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ reg.maquina }}</td>
                <td>{{ reg.actividad }}</td>
                <td>{{ reg.descripcion or '' }}</td>
                <td>{% if reg.proxima_fecha %}{{ reg.proxima_fecha.strftime('%Y-%m-%d') }}{% endif %}</td>
                <td>
                  <form method="post" action="{{ url_for('mantenimiento.eliminar_mantenimiento', mant_id=reg.id) }}" style="display:inline;">
                    <button type="submit" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i></button>
                  </form>
                  <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editarMantModal{{ reg.id }}"><i class="bi bi-pencil"></i></button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm mb-4 animate__animated animate__fadeInRight">
          <div class="card-header bg-info text-white"><b><i class="bi bi-calendar-check"></i> {{ _('Upcoming activities') }}</b></div>
          <ul class="list-group list-group-flush">
            {% for prox in proximas_actividades %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <b>{{ prox.maquina }}</b> - {{ prox.actividad }}<br>
                <small class="text-muted">{{ _('Next') }}: {{ prox.proxima_fecha.strftime('%Y-%m-%d') }}</small>
              </div>
              <div>
                <form method="post" action="{{ url_for('mantenimiento.descartar_proxima', mant_id=prox.id) }}" style="display:inline;">
                  <button type="submit" class="btn btn-outline-danger btn-sm"><i class="bi bi-x-circle"></i></button>
                </form>
                <form method="post" action="{{ url_for('mantenimiento.realizar_proxima', mant_id=prox.id) }}" style="display:inline;">
                  <button type="submit" class="btn btn-outline-success btn-sm"><i class="bi bi-check-circle"></i></button>
                </form>
              </div>
            </li>
            {% else %}
            <li class="list-group-item text-muted">{{ _('No upcoming activities scheduled.') }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
$(document).ready(function(){
  $('#tabla-mant').DataTable({
    "language": {"url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"},
    "order": [[0, "desc"]]
  });
});
</script>
{% endblock %}